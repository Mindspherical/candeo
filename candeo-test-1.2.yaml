blueprint:
  name: Candeo Test (final throttled)
  description: >
    **Smart Bulb control for C-ZB-RD1P (Remote Mode or Dual Purpose Mode) using zigbee2mqtt**

    Final patch set:
    - Trigger on started_rotating_* (for tiny nudges) AND rotating_* (for sustained turns)
    - Hard throttle gate using this.attributes.last_triggered (prevents flooding)
    - Force transition: 0 on rotate actions
    - Fix HA key: trigger (not triggers)
    - Pass target via !input target_lights (not templated)

  domain: automation
  homeassistant:
    min_version: 2024.6.0

  input:
    device_section:
      name: Device & Target Selection
      icon: mdi:devices
      description: Select your RD1P device, target lights, and mode helper
      input:
        remote_device:
          name: C-ZB-RD1P Remote Device
          description: The C-ZB-RD1P device in remote mode or dual purpose mode.
          selector:
            device:
              filter:
                - model_id: C-ZB-RD1P-REM
                - model_id: C-ZB-RD1P-DPM

        target_lights:
          name: Target Lights
          description: Light, light group, or area to control with the rotary remote
          selector:
            target:
              entity:
                domain: light

        mode_helper:
          name: Mode Helper
          description: Input select helper to track current control mode (brightness/white_temp/colour)
          selector:
            entity:
              filter:
                - domain: input_select

    control_section:
      name: Control Settings
      icon: mdi:tune
      description: Configure how much each rotation step changes your lights
      input:
        brightness_step:
          name: Brightness Step
          description: How much to change brightness per rotation step (1-50%)
          default: 10
          selector:
            number:
              min: 1
              max: 50
              unit_of_measurement: "%"

        color_temp_step:
          name: Color Temperature Step
          description: How much to change color temperature per rotation step (10-100 mired)
          default: 25
          selector:
            number:
              min: 10
              max: 100
              unit_of_measurement: "mired"

        hue_step:
          name: Hue Step
          description: How much to change hue per rotation step in colour mode (5-60 degrees)
          default: 15
          selector:
            number:
              min: 5
              max: 60
              unit_of_measurement: "degrees"

    advanced_section:
      name: Advanced Options
      icon: mdi:cog
      description: Optional settings for enhanced functionality
      collapsed: true
      input:
        show_notifications:
          name: Show Mode Notifications
          description: Display notifications when switching between modes
          default: true
          selector:
            boolean:

mode: single
max_exceeded: silent

variables:
  target_lights: !input target_lights
  brightness_step: !input brightness_step
  color_temp_step: !input color_temp_step
  hue_step: !input hue_step
  show_notifications: !input show_notifications
  # Hard cap command rate. Start at 250ms for Tuya-ish bulbs; reduce to 150â€“200ms if stable.
  rotate_throttle_ms: 250

trigger:
  # Single Press - Toggle
  - trigger: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: pressed
    id: toggle_lights

  # Double Press - Mode Cycle
  - trigger: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: double_pressed
    id: cycle_mode

  # Rotation Actions (start + continuous)
  - trigger: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: started_rotating_right
    id: start_right

  - trigger: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: started_rotating_left
    id: start_left

  - trigger: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: rotating_right
    id: rotate_right

  - trigger: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: rotating_left
    id: rotate_left

action:
  # HARD THROTTLE GATE (prevents flooding on rotate triggers)
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ trigger.id in ['start_left','start_right','rotate_left','rotate_right'] }}"
        sequence:
          - condition: template
            value_template: >
              {% set lt = state_attr(this.entity_id, 'last_triggered') %}
              {% if lt is none %}
                true
              {% else %}
                {{ (as_timestamp(now()) - as_timestamp(lt)) * 1000 >= rotate_throttle_ms }}
              {% endif %}

  - choose:
      # Toggle Lights
      - conditions:
          - condition: trigger
            id: toggle_lights
        sequence:
          - action: light.toggle
            target: !input target_lights

      # Mode Cycling
      - conditions:
          - condition: trigger
            id: cycle_mode
        sequence:
          - choose:
              - conditions:
                  - condition: state
                    entity_id: !input mode_helper
                    state: "brightness"
                sequence:
                  - action: input_select.select_option
                    target:
                      entity_id: !input mode_helper
                    data:
                      option: "white_temp"
                  - if:
                      - condition: template
                        value_template: "{{ show_notifications }}"
                    then:
                      - action: persistent_notification.create
                        data:
                          title: "RD1P Remote Control"
                          message: "Mode: White Temperature Control ğŸŒ¡ï¸"
                          notification_id: "rd1p_mode"

              - conditions:
                  - condition: state
                    entity_id: !input mode_helper
                    state: "white_temp"
                sequence:
                  - action: input_select.select_option
                    target:
                      entity_id: !input mode_helper
                    data:
                      option: "colour"
                  - if:
                      - condition: template
                        value_template: "{{ show_notifications }}"
                    then:
                      - action: persistent_notification.create
                        data:
                          title: "RD1P Remote Control"
                          message: "Mode: Colour Control ğŸ¨"
                          notification_id: "rd1p_mode"

              - conditions:
                  - condition: state
                    entity_id: !input mode_helper
                    state: "colour"
                sequence:
                  - action: input_select.select_option
                    target:
                      entity_id: !input mode_helper
                    data:
                      option: "brightness"
                  - if:
                      - condition: template
                        value_template: "{{ show_notifications }}"
                    then:
                      - action: persistent_notification.create
                        data:
                          title: "RD1P Remote Control"
                          message: "Mode: Brightness Control â˜€ï¸"
                          notification_id: "rd1p_mode"

            default:
              - action: input_select.select_option
                target:
                  entity_id: !input mode_helper
                data:
                  option: "brightness"
              - if:
                  - condition: template
                    value_template: "{{ show_notifications }}"
                then:
                  - action: persistent_notification.create
                    data:
                      title: "RD1P Remote Control"
                      message: "Mode: Brightness Control â˜€ï¸"
                      notification_id: "rd1p_mode"

      # Rotate Right (start + continuous)
      - conditions:
          - condition: trigger
            id:
              - rotate_right
              - start_right
        sequence:
          - choose:
              # Brightness Mode
              - conditions:
                  - condition: state
                    entity_id: !input mode_helper
                    state: "brightness"
                sequence:
                  - action: light.turn_on
                    target: !input target_lights
                    data:
                      transition: 0
                      brightness_step_pct: "{{ brightness_step }}"

              # White Temperature Mode
              - conditions:
                  - condition: state
                    entity_id: !input mode_helper
                    state: "white_temp"
                sequence:
                  - action: light.turn_on
                    target: !input target_lights
                    data:
                      transition: 0
                      color_temp: >
                        {% if target_lights.entity_id is defined %}
                          {% set entity = target_lights.entity_id %}
                        {% elif target_lights.area_id is defined %}
                          {% set entity = area_entities(target_lights.area_id) | select('match', 'light\.') | list | first %}
                        {% else %}
                          {% set entity = expand(target_lights.entity_id) | map(attribute='entity_id') | list | first %}
                        {% endif %}
                        {% if entity %}
                          {% set current = state_attr(entity, 'color_temp') | int(250) %}
                          {% set new_temp = current + color_temp_step %}
                          {% if new_temp > 500 %}500{% else %}{{ new_temp }}{% endif %}
                        {% else %}
                          250
                        {% endif %}

              # Colour Mode (Hue)
              - conditions:
                  - condition: state
                    entity_id: !input mode_helper
                    state: "colour"
                sequence:
                  - action: light.turn_on
                    target: !input target_lights
                    data:
                      transition: 0
                      hs_color: >
                        {% if target_lights.entity_id is defined %}
                          {% set entity = target_lights.entity_id %}
                        {% elif target_lights.area_id is defined %}
                          {% set entity = area_entities(target_lights.area_id) | select('match', 'light\.') | list | first %}
                        {% else %}
                          {% set entity = expand(target_lights.entity_id) | map(attribute='entity_id') | list | first %}
                        {% endif %}
                        {% if entity %}
                          {% set current_hue = state_attr(entity, 'hs_color')[0] | int(0) if state_attr(entity, 'hs_color') else 0 %}
                          {% set current_sat = state_attr(entity, 'hs_color')[1] | int(100) if state_attr(entity, 'hs_color') else 100 %}
                          {% set new_hue = (current_hue + hue_step) % 360 %}
                          [{{ new_hue }}, {{ current_sat }}]
                        {% else %}
                          [0, 100]
                        {% endif %}

      # Rotate Left (start + continuous)
      - conditions:
          - condition: trigger
            id:
              - rotate_left
              - start_left
        sequence:
          - choose:
              # Brightness Mode
              - conditions:
                  - condition: state
                    entity_id: !input mode_helper
                    state: "brightness"
                sequence:
                  - action: light.turn_on
                    target: !input target_lights
                    data:
                      transition: 0
                      brightness_step_pct: "{{ -brightness_step }}"

              # White Temperature Mode
              - conditions:
                  - condition: state
                    entity_id: !input mode_helper
                    state: "white_temp"
                sequence:
                  - action: light.turn_on
                    target: !input target_lights
                    data:
                      transition: 0
                      color_temp: >
                        {% if target_lights.entity_id is defined %}
                          {% set entity = target_lights.entity_id %}
                        {% elif target_lights.area_id is defined %}
                          {% set entity = area_entities(target_lights.area_id) | select('match', 'light\.') | list | first %}
                        {% else %}
                          {% set entity = expand(target_lights.entity_id) | map(attribute='entity_id') | list | first %}
                        {% endif %}
                        {% if entity %}
                          {% set current = state_attr(entity, 'color_temp') | int(250) %}
                          {% set new_temp = current - color_temp_step %}
                          {% if new_temp < 153 %}153{% else %}{{ new_temp }}{% endif %}
                        {% else %}
                          250
                        {% endif %}

              # Colour Mode (Hue)
              - conditions:
                  - condition: state
                    entity_id: !input mode_helper
                    state: "colour"
                sequence:
                  - action: light.turn_on
                    target: !input target_lights
                    data:
                      transition: 0
                      hs_color: >
                        {% if target_lights.entity_id is defined %}
                          {% set entity = target_lights.entity_id %}
                        {% elif target_lights.area_id is defined %}
                          {% set entity = area_entities(target_lights.area_id) | select('match', 'light\.') | list | first %}
                        {% else %}
                          {% set entity = expand(target_lights.entity_id) | map(attribute='entity_id') | list | first %}
                        {% endif %}
                        {% if entity %}
                          {% set current_hue = state_attr(entity, 'hs_color')[0] | int(0) if state_attr(entity, 'hs_color') else 0 %}
                          {% set current_sat = state_attr(entity, 'hs_color')[1] | int(100) if state_attr(entity, 'hs_color') else 100 %}
                          {% set new_hue = (current_hue - hue_step) % 360 %}
                          [{{ new_hue }}, {{ current_sat }}]
                        {% else %}
                          [0, 100]
                        {% endif %}
